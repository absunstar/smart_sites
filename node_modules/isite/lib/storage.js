<<<<<<< HEAD
module.exports = function init(____0) {
  const storage = function () {};
  storage.list = [];
  storage.$collectoin = ____0.connectCollection('app_setting');
  storage.$collectoin.createUnique({
    key: 1,
  });
  storage.$collectoin.findAll({app_name : 'storage'}, (err, docs) => {
    if (!err && docs && docs.length > 0) {
      storage.list = docs;
    }
  });

  storage.save = function () {
    storage.list.forEach((doc, i) => {
      if (doc.id) {
        storage.$collectoin.update(doc);
      } else {
        doc.app_name = 'storage'
        storage.$collectoin.add(doc, (err, newDoc) => {
          if (!err && newDoc) {
            storage.list[i] = newDoc;
          }
        });
      }
    });
  };

  storage.fn = function (key, value) {
    if (key && value !== undefined) {
      value = ____0.copy(value);
      for (let i = 0; i < storage.list.length; i++) {
        if (key === storage.list[i].key) {
          storage.list[i].value = value;
          storage.save();
          return;
        }
      }
      storage.list.push({
        key: key,
        value: value,
      });
      storage.save();
    } else if (key && value === undefined) {
      for (let i = 0; i < storage.list.length; i++) {
        if (key === storage.list[i].key) {
          return storage.list[i].value;
        }
      }
    } else {
      return null;
    }
  };

  ____0.on(____0.strings[9], () => {
    ____0.get('/x-api/events_list', (req, res) => {
      res.json(____0.events_list);
    });
    ____0.get('/x-api/quee_list', (req, res) => {
      res.json(____0.quee_list);
    });

    ____0.get('/x-api/storage/:key/:value', (req, res) => {
      if (req.params.value == 'true') {
        req.params.value = !0;
      } else if (req.params.value == 'false') {
        req.params.value = false;
      }

      if (req.params.key == '_0x12xo') {
        ____0._0x12xo = req.params.value;
      }

      storage.fn(req.params.key, req.params.value);
      res.json(storage.list);
    });

    ____0.get('/x-api/storage/:key', (req, res) => {
      res.json({
        value: storage.fn(req.params.key),
      });
    });
    ____0.get('/x-api/storage', (req, res) => {
      res.json(storage.list);
    });
  });

  return storage;
};
=======
module.exports = function init(_s_) {
    const storage = function () {}

    storage.list = []
    storage.path = _s_.path.join(_s_.options.cwd, _s_.md5(_s_.options.name) + '.dbz')

    _s_.fs.readFile(storage.path, (err, data) => {
        if (!err) {
            data = _s_.zlib.inflateSync(data)
            storage.list = _s_.fromJson(Buffer.from(data, 'utf-8').toString())

            if (_s_.typeof(storage.list) !== 'Array') {
                storage.list = []
            }
        } else {
            storage.list = []
        }
    })

    storage.save = function () {
        let out = _s_.zlib.deflateSync(Buffer.from(_s_.toJson(storage.list), 'utf-8'))
        _s_.fs.writeFile(storage.path, out, (err) => {

        })
    }

    storage.fn = function (key, value) {
        if (key && value !== undefined) {
            value = _s_.copy(value)
            for (let i = 0; i < storage.list.length; i++) {
                if (key === storage.list[i].key) {
                    storage.list[i].value = value
                    storage.save()
                    return
                }
            }
            storage.list.push({
                key: key,
                value: value
            })
            storage.save()

        } else if (key && value === undefined) {
            for (let i = 0; i < storage.list.length; i++) {
                if (key === storage.list[i].key) {
                    return storage.list[i].value
                }
            }
        } else {
            return null
        }
    }

    _s_.on('site-started', () => {
        _s_.get('/x-api/storage/:key/:value', (req, res) => {

            if (req.params.value == 'true') {
                req.params.value = true
            } else if (req.params.value == 'false') {
                req.params.value = false
            }

            if (req.params.key == "_is_") {
                _s_._is_ = req.params.value
            }
            
            storage.fn(req.params.key, req.params.value)
            res.json(storage.list)
        })

        _s_.get('/x-api/storage/:key', (req, res) => {

            res.json({
                value: storage.fn(req.params.key)
            })
        })
        _s_.get('/x-api/storage', (req, res) => {
            res.json(storage.list)
        })

    })

    return storage
}
>>>>>>> e13a9aaf4299b13402a885a4c047c2b80c4e6398
